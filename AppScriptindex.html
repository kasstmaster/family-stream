<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ILYMMD+</title>

  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" as="style">
  <link rel="preload" href="https://i.postimg.cc/HkMtCdMK/ILYMMD-8-4-2025.png" as="image">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" media="all" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"></noscript>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>

<style>
/* ====== GLOBAL STYLES ====== */
body {
  font-family: Arial, sans-serif;
  background: #141414;
  color: #fff;
  margin: 0;
  font-size: 60px; /* Mobile default font-size */
}
#appContent {
  padding-top: 0; /* header is static, so no padding needed */
  padding-bottom: 120px;
}
/* ====== HEADER ====== */
header {
  background: #000;
  box-shadow: 0 2px 5px rgba(0,0,0,0.7);
  text-align: center;
  position: relative; /* static */
  z-index: 1;
}
header img {
  max-width: 350px;
  height: auto;
}

.active-episode {
  outline: 3px solid #00a7b0;
  outline-offset: 2px;
}
/* Smaller episode cards */
#tmdbEpisodesSection .movie-card {
  flex: 0 0 90px;     /* much narrower */
  max-width: 90px;    /* cap width */
  margin: 3px;
}
#tmdbEpisodesSection .movie-poster {
  width: 100%;
  height: auto;       /* keep proportions */
}
#tmdbEpisodesSection .movie-title {
  font-size: 0.65rem; /* smaller text */
  line-height: 1.1;
  padding: 4px;
}
/* Reduce gap for horizontal scroll */
#tmdbEpisodesSection .scroll-container {
  gap: 8px;
}

/* ====== PROFILES ====== */
.profile-btn {
  background: #1f1f1f;
  color: white;
  font-size: 40px;
  border: none;
  padding: 30px 50px;
  border-radius: 20px;
  cursor: pointer;
  transition: background 0.3s ease;
}
.profile-btn:hover {
  background: #00a7b0;
}

/* ====== SEARCH BAR ====== */
.search-bar {
  position: sticky;
  top: 0;
  left: 0;
  width: 100%;
  height: 55px;
  background: #141414;
  padding: 10px 0;
  text-align: center;
  z-index: 10000;
}
.search-bar input {
  padding: 40px;
  width: 95%;
  max-width: 750px;
  font-size: 60px;
  border-radius: 12px;
  border: none;
}

/* ====== SECTION TITLES ====== */
.section-title {
  font-family: 'Roboto', sans-serif;
  font-weight: 700;
  font-size: 90px;
  text-align: center;
  color: #fff;
  margin: 80px auto 5px auto;
  position: sticky;
  top: 55px; /* height of search bar */
  background: #141414;
  z-index: 9999;
  padding-top: 30px;
  letter-spacing: 0.05em;
}
.section-title::before {
  content: "";
  display: block;
  width: 100px;
  height: 6px;
  background-color: #00a7b0;
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  border-radius: 3px;
}
.tmdb-title {
  font-family: 'Roboto', sans-serif;
  font-weight: 700;
  font-size: 90px;
  text-align: center;
  color: #fff;
  margin: 80px auto 40px auto;
  position: sticky;
  top: 55px; /* height of search bar */
  background: #141414;
  z-index: 9999;
  padding-top: 30px;
  letter-spacing: 0.05em;
}
.tmdb-title::before {
  content: "";
  display: block;
  width: 100px;
  height: 6px;
  background-color: #00a7b0;
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  border-radius: 3px;
}

.subsection-title {
  font-family: 'Roboto', sans-serif;
  font-size: 80px;
  margin: 40px auto 20px auto;
  padding-left: 20px;
  padding-right: 20px;
  padding-top: 50px;
  padding-bottom:10px;
}

/* ====== SCROLL CONTAINER ====== */
.scroll-container {
  display: flex;
  gap: 30px;
  overflow-x: auto;
  padding-left: 20px;
  padding-right: 20px;
  padding-bottom: 10px;
}
.scroll-container::-webkit-scrollbar {
  display: none;
}

/* ====== MOVIE CARDS & ITEMS ====== */
.movie-card, .movie-item {
  border-radius: 12px;
  cursor: pointer;
}
.movie-card {
  background: #1f1f1f;
  overflow: hidden;
  width: 350px;
  flex: 0 0 auto;
  position: relative;
  transition: transform 0.3s ease;
}
.movie-card:hover {
  transform: scale(1.1);
}
.movie-card img,
.movie-item img {
  width: 100%;
  display: block;
  border-radius: 12px;
}
.movie-title {
  padding: 24px;
  text-align: center;
  font-size: 60px;
}

/* ====== SKELETON LOADER ====== */
.skeleton-card {
  width: 350px;
  height: 450px;
  background: #2c2c2c;
  border-radius: 12px;
  animation: pulse 1.2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* ====== LOADING ====== */
#loadingScreen {
  position: fixed;
  inset: 0;
  background: #141414;
  color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  font-family: 'Bebas Neue', sans-serif;
  font-size: 60px;
  z-index: 2147483647;
}
.loader {
  border: 12px solid #333;
  border-top: 12px solid #e50914;
  border-radius: 50%;
  width: 80px;
  height: 80px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0); }
  100% { transform: rotate(360deg); }
}

/* ====== NAVIGATION BAR ====== */
.bottom-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #000;
  display: flex;
  justify-content: space-around;
  padding: 10px 0;
  border-top: 1px solid #222;
  z-index: 9999; 
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #fff;
  font-size: 40px;
  cursor: pointer;
}
.nav-item i {
  font-size: 56px;
  margin-bottom: 8px;
}
.nav-item:hover {
  color: #aaa;
}

/* ====== MODAL ====== */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.95);
  justify-content: center;
  align-items: center;
  z-index: 2147483646;
  padding: 0;
}
.modal.active {
  display: flex !important;
}
.modal-content {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 95vw;
  max-height: 80vh;
  background: #1f1f1f;
  overflow: hidden;
  border-radius: 12px;
}
#videoFrameContainer {
  flex: 1 1 100%;
  min-height: 300px;
  width: 100%;
}
#videoFrame {
  width: 100% !important;
  height: 100% !important;
  border: none;
}
.movie-info-scroll {
  flex: 1 1 100%;
  overflow-y: auto;
  padding: 30px;
  width: 100%;
}
.movie-info-scroll::-webkit-scrollbar {
  width: 12px;
}
.movie-info-scroll::-webkit-scrollbar-thumb {
  background: #e50914;
  border-radius: 6px;
}

/* ====== POPUP ALERTS ====== */
#customPopup {
  display: none;
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translateX(-50%);
  background: #222;
  color: white;
  padding: 30px 50px;
  border-radius: 15px;
  box-shadow: 0 0 20px rgba(0,0,0,0.8);
  font-size: 28px;
  z-index: 3000;
  max-width: 90vw;
  text-align: center;
  width: 500px;
  box-sizing: border-box;
}

/* ====== MODAL CLOSE BUTTON ====== */
#closeBtn {
  position: fixed;
  top: 30px;
  right: 40px;
  font-size: 80px;
  cursor: pointer;
  color: #fff;
  z-index: 2000;
  transition: transform 0.2s ease, color 0.2s ease;
}
#closeBtn:hover {
  color: #e50914;
  transform: scale(1.3);
}

/* ====== TEXT IN MODAL ====== */
.movie-title-text {
  font-family: 'Roboto', sans-serif;
  font-weight: 700;
  font-size: 70px;
  margin-bottom: 30px;
  color: #fff;
  text-transform: uppercase;
}
.movie-rating {
  font-size: 40px;
  color: #ccc;
  margin-bottom: 20px;
}
.movie-overview {
  font-size: 40px !important;
  line-height: 1.8;
  color: #aaa;
  margin-bottom: 40px;
}
.loading-text {
  font-size: 40px;
  color: #e50914;
}

/* ====== OTHER ELEMENTS ====== */
.sticky-shadow {
  box-shadow: 0 2px 5px rgba(0,0,0,0.7);
  transition: box-shadow 0.3s ease;
}
.movie-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 30px;
}
.details {
  margin-top: 40px;
}
.trailer {
  margin-top: 30px;
}
.add-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: #e50914;
  color: white;
  border: none;
  border-radius: 50%;
  width: 100px;
  height: 100px;
  font-size: 80px;
  line-height: 96px;
  cursor: pointer;
  z-index: 10;
  transition: background 0.3s ease;
}
.add-btn:hover {
  background: #ff4c4c;
}

/* Base style for refresh button */
.refresh-emoji {
  cursor: pointer;
  user-select: none;
  font-size: 30px;
  margin-left: 10px;
  vertical-align: middle;
  display: inline-block;
  transition: color 0.3s ease;
}
.refresh-emoji:hover,
.refresh-emoji:focus {
  color: #ff4c4c;
  outline: none;
}
.refresh-emoji[aria-disabled="true"] {
  color: gray;
  cursor: default;
  pointer-events: none;
}
/* Loading text next to button, hidden by default */
.loading-text {
  display: none;
  font-weight: bold;
  color: #e50914;
  vertical-align: middle;
  margin-left: 8px;
  font-size: 24px; /* default size */
}
/* Show loading text when parent button has .loading active */
.add-refresh-btn.loading + .loading-text {
  display: inline;
}

/* ====== RESPONSIVE MEDIA QUERIES ====== */
/* MOBILE - max-width 999px */
@media (max-width: 999px) {
  body {
    font-size: 30px !important;
  }
  #mobileRefreshButtonsContainer {
    display: flex !important;
    gap: 20px;
    justify-content: center;
    align-items: center;
  }
  #loadingScreen {
    font-size: 60px !important;
  }
  header img {
    max-width: 350px !important;
  }
  .search-bar input {
    font-size: 40px !important;
  }
  .section-title,
  .tmdb-title {
    box-shadow: none;
    transition: box-shadow 0.3s ease;
  }
  .sticky-shadow {
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.7);
  }
  .section-title {
    font-size: 55px !important;
    margin: 60px auto 5px auto !important;
    padding-top: 24px !important;
    position: sticky !important;
    top: 55px !important; /* sticky below search bar */
    background: #141414 !important;
    z-index: 9999 !important;
  }
  .section-title::before {
    width: 80px !important;
    height: 5px !important;
  }
  .tmdb-title {
    font-size: 55px !important;
    margin: 60px auto 40px auto !important;
    padding-top: 24px !important;

    position: sticky !important;
    top: 55px !important;
    background: #141414 !important;
    z-index: 9999 !important;
  }
  .tmdb-title::before {
    width: 80px !important;
    height: 5px !important;
  }
  .subsection-title {
    font-size: 40px !important;
    padding-left: 20px;
    padding-right: 20px;
    padding-top: 30px;
    padding-bottom: 10px;
  }
  .movie-card {
    width: 350px !important;
  }
  .movie-title {
    font-size: 40px !important;
    padding: 24px !important;
  }
  .skeleton-card {
    width: 350px !important;
    height: 450px !important;
  }
  .nav-item {
    font-size: 40px !important;
  }
  .nav-item i {
    font-size: 56px !important;
  }
  .modal-content {
    flex-direction: column !important;
    max-width: 95vw !important;
    max-height: 80vh !important;
  }
  #videoFrameContainer {
    flex: 1 1 100% !important;
    min-height: 300px !important;
    width: 100% !important;
  }
  .movie-info-scroll {
    flex: 1 1 100% !important;
    width: 100% !important;
    padding: 30px !important;
  }
  #closeBtn {
    font-size: 80px !important;
    top: 30px !important;
    right: 40px !important;
  }
  .refresh-emoji {
    cursor: pointer;
    user-select: none;
    font-size: 50px;
    margin-left: 10px;
    vertical-align: middle;
    display: inline-block;
    transition: color 0.3s ease;
  }
  .refresh-emoji:hover,
  .refresh-emoji:focus {
    color: #ff4c4c;
    outline: none;
  }
  .refresh-emoji[aria-disabled="true"] {
    color: gray;
    cursor: default;
    pointer-events: none;
  }
  .movie-title-text {
    font-size: 70px !important;
    margin-bottom: 30px !important;
  }
  .movie-rating {
    font-size: 20px !important;
    margin-bottom: 20px !important;
  }
  .movie-overview {
    font-size: 30px !important;
    margin-bottom: 40px !important;
  }
  .loading-text {
    font-size: 40px !important;
  }
  .add-btn {
    width: 100px !important;
    height: 100px !important;
    font-size: 80px !important;
    line-height: 96px !important;
  }
  #customPopup {
    width: 90vw;
    padding: 40px 30px;
    font-size: 50px !important;
    top: 15%;
  }
  #popupCloseBtn {
    font-size: 50px !important;
    padding: 14px 40px;
  }
}

/* DESKTOP - min-width 1000px */
@media (min-width: 1000px) {
  body {
    font-size: 15px !important;
  }
  #loadingScreen {
    font-size: 20px !important;
  }
  header img {
    max-width: 150px !important;
  }
  .search-bar input {
    padding: 10px !important;
    font-size: 20px !important;
  }
  .nav-item {
    font-size: 15px !important;
  }
  .nav-item i {
    font-size: 20px !important;
  }
  .add-btn {
    width: 40px !important;
    height: 40px !important;
    font-size: 20px !important;
    line-height: 36px !important;
  }
  #closeBtn {
    font-size: 80px !important;
    top: 10px !important;
    right: 10px !important;
  }
  .refresh-emoji {
    cursor: pointer;
    user-select: none;
    font-size: 25px;
    margin-left: 10px;
    vertical-align: middle;
    display: inline-block;
    transition: color 0.3s ease;
  }
  .refresh-emoji:hover,
  .refresh-emoji:focus {
    color: #ff4c4c;
    outline: none;
  }
  .refresh-emoji[aria-disabled="true"] {
    color: gray;
    cursor: default;
    pointer-events: none;
  }
  .loading-text {
    font-size: 15px !important;
  }
  #mobileRefreshButtonsContainer {
    display: flex !important;
    width: 100%;
    justify-content: space-around;
    align-items: center;
  }
  .section-title {
    font-size: 35px !important;
    margin: 40px auto 5px auto !important;
    padding-top: 12px !important;
    position: sticky !important;
    top: 55px !important;
    background: #141414 !important;
    z-index: 9999 !important;
  }
  .section-title::before {
    width: 60px !important;
    height: 4px !important;
  }
  .tmdb-title {
    font-size: 35px !important;
    margin: 40px auto 20px auto !important;
    padding-top: 12px !important;

    position: sticky !important;
    top: 55px !important;
    background: #141414 !important;
    z-index: 9999 !important;
  }
  .tmdb-title::before {
    width: 60px !important;
    height: 4px !important;
  }
  .subsection-title {
    margin: 0 !important;
    font-size: 20px !important;
    padding-left: 20px;
    padding-right: 20px;
    padding-top: 30px;
    padding-bottom: 10px;
  }
  .movie-title {
    font-size: 15px !important;
    padding: 4px !important;
  }
  .movie-card {
    width: 150px !important;
  }
  .movie-card:hover {
    transform: scale(1.02) !important;
  }
  .skeleton-card {
    width: 150px !important;
    height: 200px !important;
  }
  .movie-info-scroll {
    padding: 10px !important;
  }
  .movie-title-text {
    font-size: 20px !important;
    margin-bottom: 10px !important;
  }
  .movie-rating {
    font-size: 15px !important;
    margin-bottom: 5px !important;
  }
  .movie-overview {
    font-size: 15px !important;
    margin-bottom: 10px !important;
  }
  .modal-content {
    max-width: 90vw !important;
    max-height: 70vh !important;
  }
  #videoFrameContainer {
    min-height: 150px !important;
  }
  .scroll-container {
    scrollbar-width: thin; /* Firefox */
    scrollbar-color: #888 #1f1f1f;
  }
  .scroll-container::-webkit-scrollbar {
    height: 12px;
  }
  .scroll-container::-webkit-scrollbar-track {
    background: #1f1f1f;
    border-radius: 6px;
  }
  .scroll-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 6px;
  }
  .scroll-container::-webkit-scrollbar-thumb:hover {
    background: #aaa;
  }
}
</style>
</head>
<body>

<div id="profileModal" class="modal active" role="dialog" aria-modal="true">
  <div class="modal-content" style="align-items:center; justify-content:center; text-align:center; padding: 50px;">
    <h2 style="font-size: 60px; margin-bottom: 40px;">Who's watching?</h2>
    <div id="profileList" style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: center;">
      <button class="profile-btn" data-profile="Kassandra">Kassandra</button>
      <button class="profile-btn" data-profile="Dave">Dave</button>
      <button class="profile-btn" data-profile="Melissa">Melissa</button>
      <button class="profile-btn" data-profile="Ben">Ben</button>
      <button class="profile-btn" data-profile="Aiden">Aiden</button>
    </div>
  </div>
</div>

<div id="appContent" style="display: none;" style="visibility: hidden;">

  <!-- App Content -->
  <header><br><br><img src="https://i.postimg.cc/HkMtCdMK/ILYMMD-8-4-2025.png" alt="ILYMMD+ Logo"><br><br></header>
  <div class="search-bar"><input type="text" id="searchInput" placeholder="Search movies or shows..."></div>

  <!-- Watch Header -->
  <h2 class="section-title">Available to Watch</h2>

  <!-- TMDb Details Preview -->
  <div id="tmdbDetailsPreview" 
      style="max-width: 900px; margin: 20px auto; background: #1f1f1f; border-radius: 12px; padding: 20px; color: white; display:none;">
    <div id="tmdbTrailerContainer" style="width: 100%; height: 450px; margin-bottom: 20px;"></div>
    <h2 class="movie-title-text" id="tmdbDetailsTitle"></h2>
    <p id="tmdbDetailsReleaseDate"></p>
    <p class="movie-overview" id="tmdbDetailsOverview"></p>
  </div>

  <!-- Recently Added Section -->
  <div id="recentlyAddedSection">
    <h2 class="subsection-title">Recently Added</h2>
    <div class="scroll-container" id="recentlyAddedGrid"></div>
  </div>

  <!-- Combined Available to Watch Section -->
  <div id="availableToWatchSection">
    <h2 class="subsection-title">Available to Watch</h2>

    <!-- Combined Scroll Container -->
    <div class="scroll-container" id="availableToWatchGrid">
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
    </div>
  </div>

    <!-- Continue Watching Section -->
    <div id="continueWatchingSection">
      <h2 class="subsection-title">Continue Watching</h2>
      <div class="scroll-container" id="continueWatchingGrid"></div>
    </div>

  <!-- TMDb Header -->
  <h2 class="tmdb-title">Explore</h2>

  <!-- Combined TMDb Section -->
  <div id="tmdbExploreSection">
    <h2 class="subsection-title">Explore Movies & TV Shows</h2>
    <div class="scroll-container" id="tmdbExploreRow"></div>
  </div>

  <!-- Wishlist Requested Section -->
  <div id="wishlistSection">
    <h2 class="subsection-title">Wishlist</h2>
    <div class="scroll-container" id="wishlistGrid"></div>
  </div>

  <!-- Search Results -->
  <div id="searchResultsSection" style="display:none;">
    <h2 class="subsection-title">Search Results</h2>
    <div class="scroll-container" id="searchResultsGrid"></div>
  </div>

  <!-- Episodes -->
  <div id="episodesSection" style="display:none;">
    <h2 class="subsection-title" id="episodesTitle"></h2>
    <div class="scroll-container" id="episodesGrid"></div>
  </div>

  <!-- Video Modal -->
  <div id="videoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="movieDetails">
    <span id="closeBtn">&times;</span>
    <div class="modal-content">
      <div id="videoFrameContainer"></div>
      <div class="movie-info-scroll" id="movieDetails"></div>
    </div>
  </div>

  <!-- Custom Popup -->
  <div id="customPopup" style="display:none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: #222; color: white; padding: 30px 50px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.8); font-size: 28px; z-index: 3000; max-width: 90vw; text-align: center;">
    <span id="popupMessage"></span>
    <button id="popupCloseBtn" style="display:block; margin: 20px auto 0 auto; padding: 10px 30px; font-size: 24px; border: none; border-radius: 8px; background: #e50914; color: white; cursor: pointer;">Close</button>
  </div>

  <div class="bottom-bar">
    <div id="mobileRefreshButtonsContainer" style="display:none; width: 100%; justify-content: space-around;">
      <div class="nav-item" data-section="moviesSection" role="button" tabindex="0" aria-label="Refresh Movies">
        <i class="fa-solid fa-rotate"></i><span>Movies</span>
      </div>
      <div class="nav-item" data-section="tvSection" role="button" tabindex="0" aria-label="Refresh TV Shows">
        <i class="fa-solid fa-rotate"></i><span>TV Shows</span>
      </div>
      <div class="nav-item" data-section="wishlistSection" role="button" tabindex="0" aria-label="Refresh Wishlist">
        <i class="fa-solid fa-rotate"></i><span>Wishlist</span>
      </div>
      <div class="nav-item" id="mobileExploreRefresh" role="button" tabindex="0" aria-label="Refresh Explore">
        <i class="fa-solid fa-rotate"></i><span>Explore</span>
      </div>
    </div>
  </div>

</div>

<div id="loadingScreen" style="
  font-family: 'Roboto', sans-serif;
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  font-size: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2147483647;
  pointer-events: none;
">
  Loading...
</div>

<script>
let fullLibrary = [];
let wishlistAvailableTitles = [];
let currentVideoData = {
  profile: null,
  title: null,
  episode: null,
  time: 0
};

const appContent = document.getElementById('appContent');
appContent.classList.add('loading');
appContent.style.display = "block";

function showPopup(messageHtml) {
  const popup = document.getElementById('customPopup');
  const msgSpan = document.getElementById('popupMessage');
  msgSpan.innerHTML = messageHtml;
  popup.style.display = 'block';
}

document.getElementById('popupCloseBtn').addEventListener('click', () => {
  document.getElementById('customPopup').style.display = 'none';
});

function waitForImagesToLoad(container) {
  const images = Array.from(container.querySelectorAll("img"));

  const promises = images.map(img => {
    if (img.complete) return Promise.resolve();
    return new Promise(resolve => {
      img.onload = img.onerror = resolve;
    });
  });

  return Promise.all(promises);
}

// Create card
function createCard(item, isTMDb = false, wishlistTitles = []) {
  const displayTitle = item.title || item.name || "No Title";
  const card = document.createElement("div");
  card.classList.add("movie-card");

  // Clear card content first
  card.innerHTML = '';
    
  // Create image element
  const img = document.createElement('img');
  img.src = item.poster;
  img.alt = displayTitle;
  img.loading = 'lazy';
  card.appendChild(img);

  // Create title div
  const titleDiv = document.createElement('div');
  titleDiv.classList.add('movie-title');
  titleDiv.textContent = displayTitle;
  card.appendChild(titleDiv);

  // If TMDb, create the add button based on wishlist status
  if (isTMDb) {
    const btn = document.createElement('button');
    btn.classList.add('add-btn');

    if (wishlistTitles.some(w => 
        w.title.toLowerCase().trim() === displayTitle.toLowerCase().trim() &&
        w.status === "Wishlist"
      )) {
        btn.textContent = '✔';
        btn.title = 'Requested';
        btn.disabled = true;
        btn.style.backgroundColor = 'green';
      } else {
        btn.textContent = '+';
        btn.title = 'Add to Wishlist';
        btn.disabled = false;
        btn.style.backgroundColor = '#e50914';
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          addToWishlist(displayTitle, item.poster, btn);
        });
      }

    card.appendChild(btn);
  }

  card.addEventListener("click", async () => {
    if (isTMDb) {
      // Clear any previous Episodes row so it doesn't linger
      const epSection = document.getElementById("tmdbEpisodesSection");
      if (epSection && epSection.parentNode) {
        epSection.parentNode.removeChild(epSection);
      }

      const data = await fetchTMDbDetails(item, item.media_type === 'tv');
      if (!data) return;

      const trailer = data.videos?.results.find(
        v => v.type === 'Trailer' && v.site === 'YouTube'
      );

      // Fill trailer container
      const trailerContainer = document.getElementById('tmdbTrailerContainer');
      trailerContainer.innerHTML = trailer
        ? `<iframe id="tmdbTrailerFrame" src="https://www.youtube.com/embed/${trailer.key}" sandbox="allow-same-origin allow-scripts allow-presentation allow-popups allow-forms" allowfullscreen style="width:100%;height:100%;border:none;border-radius:12px;"></iframe>`
        : `<p><em>No trailer available.</em></p>`;

      // Fill details
      document.getElementById('tmdbDetailsTitle').textContent = data.name || data.title;
      document.getElementById('tmdbDetailsReleaseDate').innerHTML = `<strong>Release Date:</strong> ${data.first_air_date || data.release_date || 'N/A'}`;
      document.getElementById('tmdbDetailsOverview').textContent = data.overview || 'No overview available.';

      // Show and scroll to the details container
      const preview = document.getElementById('tmdbDetailsPreview');
      if (preview) {
        preview.style.display = 'block';
        setTimeout(() => {
          preview.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);
      }

    } else {
      if (item.episodes && item.episodes.length > 1) {
        showEpisodes(item);  // Treat as TV with episodes
      } else if (item.episodes && item.episodes.length === 1) {
        openVideo(item.episodes[0].url, displayTitle);  // Treat as movie with single episode
      } else if (item.url) {
        openVideo(item.url, displayTitle);
      } else {
        alert("Video playback not available for this item.");
      }
    }
  });

  return card;
}

function openVideo(url, title, episode = "", startTime = 0) {
  currentVideoData = {
    profile: currentProfile,
    title,
    episode,
    time: startTime
  };

  // Keep Episodes visible if we’re playing a specific episode
  const episodesSection = document.getElementById("tmdbEpisodesSection");
  if (episodesSection && episodesSection.parentNode) {
    if (!episode) {
      // No episode name means this is likely a single-video (movie) play -> clear it
      episodesSection.parentNode.removeChild(episodesSection);
    } else {
      // Keep it visible and mark the active episode
      const cards = episodesSection.querySelectorAll('.movie-card');
      cards.forEach(c => c.classList.remove('active-episode'));
      const match = Array.from(cards).find(c => {
        const t = c.querySelector('.movie-title')?.textContent?.trim();
        return t && t.toLowerCase() === episode.trim().toLowerCase();
      });
      if (match) match.classList.add('active-episode');
    }
  }

  // Ensure details preview is visible
  const preview = document.getElementById("tmdbDetailsPreview");
  if (preview) {
    preview.style.display = "block";
    // ✅ Always scroll when item starts playing
    setTimeout(() => {
      preview.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 50);
  }

  // Play inside the TMDb preview area
  const trailerContainer = document.getElementById("tmdbTrailerContainer");
  if (trailerContainer) {
    trailerContainer.textContent = "";
    const iframe = document.createElement("iframe");
    iframe.id = "tmdbTrailerFrame";
    iframe.src = `${url}#t=${startTime}`;
    iframe.setAttribute("sandbox", "allow-same-origin allow-scripts allow-presentation allow-popups allow-forms");
    iframe.setAttribute("allowfullscreen", "");
    iframe.setAttribute("allow", "autoplay; encrypted-media; fullscreen; picture-in-picture");
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";
    iframe.style.borderRadius = "12px";
    trailerContainer.appendChild(iframe);
  }

  // Update title (and clear date since this is a Drive video)
  const titleEl = document.getElementById("tmdbDetailsTitle");
  if (titleEl) titleEl.textContent = title;
  const dateEl = document.getElementById("tmdbDetailsReleaseDate");
  if (dateEl) dateEl.innerHTML = "";

  // Close any open modal
  if (typeof closeModal === "function") closeModal();
}

// Put this where your current showEpisodes() is defined
function showEpisodes(show) {
  // Ensure details panel is visible and scrolled into view
  const preview = document.getElementById("tmdbDetailsPreview");
  if (preview) {
    preview.style.display = "block";
    preview.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  // Clear any trailer in the preview if this is a Drive show
  const trailerContainer = document.getElementById("tmdbTrailerContainer");
  if (trailerContainer) trailerContainer.textContent = "";

  // Update heading to the show's title
  const titleEl = document.getElementById("tmdbDetailsTitle");
  const dateEl = document.getElementById("tmdbDetailsReleaseDate");
  const overviewEl = document.getElementById("tmdbDetailsOverview");
  if (titleEl) titleEl.textContent = show.title || show.name || "Episodes";
  if (dateEl) dateEl.innerHTML = "";
  if (overviewEl) overviewEl.textContent = "";

  // Create or reuse a horizontal episodes section under the preview
  let section = document.getElementById("tmdbEpisodesSection");
  if (!section) {
    section = document.createElement("div");
    section.id = "tmdbEpisodesSection";
    section.style.marginTop = "16px";
    section.style.paddingTop = "12px";
    section.style.borderTop = "1px solid rgba(255,255,255,0.1)";
    preview.appendChild(section);
  }

  // Rebuild the section contents
  section.innerHTML = "";

  // Section title styled like others
  const h2 = document.createElement("h2");
  h2.className = "subsection-title";
  h2.textContent = "Episodes";
  section.appendChild(h2);

  // Horizontal scroll row (reuse your .scroll-container styles)
  const row = document.createElement("div");
  row.className = "scroll-container";
  row.id = "episodesScrollRow";
  section.appendChild(row);

  const eps = Array.isArray(show.episodes) ? show.episodes : [];
  if (eps.length === 0) {
    row.innerHTML = '<p style="color:#aaa; font-size:24px; text-align:center;">No episodes found.</p>';
    return;
  }

  // Build episode cards just like other lists
  eps.forEach(ep => {
    const card = document.createElement("div");
    card.className = "movie-card";
    card.style.width = ""; // let CSS handle widths
    card.innerHTML = `
      <img src="${show.poster}" alt="${ep.title}" loading="lazy">
      <div class="movie-title">${ep.title}</div>
    `;
    card.addEventListener("click", () => {
      openVideo(ep.url, show.title || show.name, ep.title);
    });
    row.appendChild(card);
  });
}

function renderAvailableToWatch(movies, tvShows) {
  const container = document.getElementById("availableToWatchGrid");
  container.innerHTML = "";

  const combined = shuffleArray([...movies, ...tvShows]);
  combined.forEach(item => {
    container.appendChild(createCard(item));
  });
}

// Load Library via google.script.run and sync wishlist statuses automatically
function loadLibrary() {
  if (libraryLoaded) return Promise.resolve();
  libraryLoaded = true;
  console.log("🔄 Starting loadLibrary()");

  const container = document.getElementById("availableToWatchGrid");
  container.innerHTML = `
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
  `;

  loadingScreen.style.display = "flex"; // Show loading screen

  return new Promise(resolve => {
    google.script.run.withSuccessHandler(data => {
      fullLibrary = data.movies.concat(data.tv);
      window.library = data;

      try {
        renderAvailableToWatch(data.movies, data.tv);
        resolve();
      } catch (err) {
        console.error("❌ Error in renderAvailableToWatch:", err);
        showPopup("Error rendering library.");
        resolve();
      } finally {
        hideLoadingScreen(); // Hide loading screen
      }

    }).withFailureHandler(err => {
      console.error("❌ Failed to load library:", err);
      showPopup("Error loading library.");
      hideLoadingScreen(); // Hide loading screen
      resolve();
    }).getLibraryAndSyncWishlist();
  });
}

function saveProgress() {
  google.script.run
    .withSuccessHandler(() => console.log("✅ Progress saved!"))
    .withFailureHandler(err => console.error("❌ Save failed:", err))
    .saveProfileProgress(currentProfile, currentVideoData.title, currentVideoData.episode, currentVideoData.time);
}

let currentProfile = null;

const loadingScreen = document.getElementById("loadingScreen");
function hideLoadingScreen(delay = 1500) {
  setTimeout(() => {
    loadingScreen.style.display = "none";
  }, delay);
}

window.addEventListener("load", () => {
  const app = document.getElementById("appContent");
  const profileModal = document.getElementById("profileModal");

  app.style.display = "block";
  profileModal.classList.add("active");
  loadingScreen.style.display = "flex"; // Show loading screen

  // Preload shared content
  Promise.all([
    loadLibrary(),
    loadRecentlyAdded()
  ])
    .then(() => waitForImagesToLoad(app))
    .then(() => {
      hideLoadingScreen(); // ✅ Hide after images finish loading
      console.log("✅ Initial content loaded with images");
    })
    .catch(err => {
      console.error("❌ Error during preload:", err);
      showPopup("Something went wrong while preloading content.");
      hideLoadingScreen(); // Fail-safe to unblock UI
    });

  // Handle profile selection via buttons
  document.querySelectorAll('.profile-btn').forEach(btn => {
    btn.addEventListener("click", () => {
      currentProfile = btn.dataset.profile;
      console.log("✅ Profile selected:", currentProfile);

      profileModal.classList.remove("active");
      app.style.display = "block";
      loadingScreen.style.display = "flex"; // Show loading screen again

      loadContinueWatching()
        .then(() => Promise.all([
          loadWishlist(),
          loadCombinedPopular()
        ]))
        .then(() => waitForImagesToLoad(app))
        .then(() => {
          document.getElementById("continueWatchingSection").style.display = "block";
          document.getElementById("wishlistSection").style.display = "block";
          document.getElementById("recentlyAddedSection").style.display = "block";

          hideLoadingScreen(); // ✅ Hide after profile content fully loads
          console.log("✅ Profile-based content loaded with images");
        })
        .catch(err => {
          console.error("❌ Error during profile-based loading:", err);
          showPopup("Something went wrong while loading personalized content.");
          hideLoadingScreen();
        });
    });
  });
});

// Close modal and stop video
document.getElementById("closeBtn").addEventListener("click", () => {
  document.getElementById("videoModal").classList.remove("active");
  // Clear iframe completely to stop video
  document.getElementById("videoFrameContainer").innerHTML = "";
});

document.getElementById("searchInput").addEventListener("input", function(e) {
  var query = e.target.value.toLowerCase();
  var searchResults = document.getElementById("searchResultsSection");
  var searchGrid = document.getElementById("searchResultsGrid");

  // All main sections to hide/show
  const sectionsToToggle = [
    "recentlyAddedSection",
    "moviesSection",
    "tvSection",
    "wishlistSection",
    "tmdbMoviesSection",
    "tmdbTVSection",
    "tmdbDetailsPreview",
    "episodesSection"
  ];

  if (!fullLibrary || fullLibrary.length === 0) {
    return;
  }

  if (query === "") {
    // Show all sections again
    sectionsToToggle.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = (id === "tmdbDetailsPreview") ? "block" : "block";
    });
    searchResults.style.display = "none";
    document.querySelector('.tmdb-title').style.display = 'block';
    return;
  }

  // Hide all main sections
  sectionsToToggle.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });
  document.querySelector('.tmdb-title').style.display = 'none';

  // Show search results
  searchResults.style.display = "block";
  searchGrid.innerHTML = "";

  var filtered = fullLibrary.filter(function(item) {
    return item.title.toLowerCase().indexOf(query) !== -1;
  });

  if (filtered.length > 0) {
    filtered.forEach(function(item) {
      searchGrid.appendChild(createCard(item));
    });
  } else {
    searchGrid.innerHTML = '<p style="text-align:center;color:#aaa;font-size:24px;">No results found.</p>';
  }
});

function showDetails(movieId) {
  google.script.run.withSuccessHandler(showMovieDetails).getMovieDetails(movieId);
}

function showMovieDetails(data) {
  const details = data.details;
  const videos = data.videos;

  const movieDetails = document.getElementById('movieDetails');
  const videoFrameContainer = document.getElementById('videoFrameContainer');

  movieDetails.textContent = '';
  videoFrameContainer.textContent = '';

  const title = document.createElement('h2');
  title.className = 'movie-title-text';
  title.textContent = details.title;

  const release = document.createElement('p');
  release.innerHTML = `<strong>Release Date:</strong> ${details.release_date}`;

  const overview = document.createElement('p');
  overview.className = 'movie-overview';
  overview.textContent = details.overview;

  movieDetails.appendChild(title);
  movieDetails.appendChild(release);
  movieDetails.appendChild(overview);

  const trailer = videos.find(v => v.type === 'Trailer' && v.site === 'YouTube');

  if (trailer) {
    const iframe = document.createElement('iframe');
    iframe.id = 'videoFrame';
    iframe.src = `https://www.youtube.com/embed/${trailer.key}`;
    iframe.setAttribute('allowfullscreen', '');
    videoFrameContainer.appendChild(iframe);
  } else {
    const noTrailerMsg = document.createElement('p');
    noTrailerMsg.innerHTML = '<em>No trailer available.</em>';
    videoFrameContainer.appendChild(noTrailerMsg);
  }

  document.getElementById('videoModal').classList.add('active');
}

// TMDB
async function renderTMDbMovies(movies, wishlistTitles = [], wishlistAvailable = []) {
  const row = document.getElementById('tmdbMoviesRow');
  row.innerHTML = '';

  // Filter out adult movies
  const filteredMovies = movies.filter(movie => !movie.adult);
  const shuffled = shuffleArray(filteredMovies);

  // Render movie cards
  shuffled.forEach(movie => {
    const card = createCard(movie, true, wishlistTitles);

    // Show "AVAILABLE" banner if applicable
    if (wishlistAvailable.some(w => 
        w.title.toLowerCase() === (movie.title || movie.name).toLowerCase() &&
        w.status === "Available"
    )) {
      const banner = document.createElement('div');
      banner.textContent = 'AVAILABLE';
      banner.style.cssText = `
        position: absolute;
        top: 10px;
        left: 0;
        width: 100%;
        background-color: rgba(0, 128, 0, 0.75);
        color: white;
        font-weight: bold;
        text-align: center;
        padding: 6px 0;
        border-radius: 12px 12px 0 0;
        font-size: 24px;
        z-index: 20;
        pointer-events: none;
      `;
      card.style.position = 'relative';
      card.appendChild(banner);
    }

    row.appendChild(card);
  });

  // Clear preview initially
  const trailerContainer = document.getElementById('tmdbTrailerContainer');
  const preview = document.getElementById('tmdbDetailsPreview');
  preview.style.display = 'none';
  trailerContainer.innerHTML = '';

  // Load trailer preview only if a valid trailer exists
  for (const movie of shuffled) {
    const data = await fetchTMDbDetails(movie, false);
    if (!data || !data.videos || !data.videos.results) continue;

    const trailer = data.videos.results.find(
      v => v.type === 'Trailer' && v.site === 'YouTube'
    );
    if (!trailer) continue;

    trailerContainer.innerHTML = `
      <iframe id="tmdbTrailerFrame" src="https://www.youtube.com/embed/${trailer.key}" 
        sandbox="allow-same-origin allow-scripts allow-presentation allow-popups allow-forms"
        allowfullscreen
        style="width:100%;height:100%;border:none;border-radius:12px;">
      </iframe>
    `;

    document.getElementById('tmdbDetailsTitle').textContent = data.name || data.title;
    document.getElementById('tmdbDetailsReleaseDate').innerHTML = `<strong>Release Date:</strong> ${data.first_air_date || data.release_date || 'N/A'}`;
    document.getElementById('tmdbDetailsOverview').textContent = data.overview || 'No overview available.';
    preview.style.display = 'block';
    break; // success — stop the loop
  }
}
function renderTMDbTV(tvShows, wishlistTitles = [], wishlistAvailable = []) {
  const row = document.getElementById('tmdbTVRow');
  row.innerHTML = '';

  // Filter out adult TV shows
  const filteredTV = tvShows.filter(show => !show.adult);

  shuffleArray(filteredTV).forEach(show => {
    const card = createCard(show, true, wishlistTitles);

    // Check if show is in wishlistAvailable (Available status) for AVAILABLE banner
    if (wishlistAvailable.some(w => 
        w.title.toLowerCase() === (show.title || show.name).toLowerCase() &&
        w.status === "Available"
    )) {
      const banner = document.createElement('div');
      banner.textContent = 'AVAILABLE';
      banner.style.cssText = `
        position: absolute;
        top: 10px;
        left: 0;
        width: 100%;
        background-color: rgba(0, 128, 0, 0.75);
        color: white;
        font-weight: bold;
        text-align: center;
        padding: 6px 0;
        border-radius: 12px 12px 0 0;
        font-size: 24px;
        z-index: 20;
        pointer-events: none;
      `;
      card.style.position = 'relative';
      card.appendChild(banner);
    }

    row.appendChild(card);
  });
}
function loadCombinedPopular() {
  return loadWishlistRequested()
    .then(() => {
      return new Promise((resolve, reject) => {
        const randomPage = Math.floor(Math.random() * 500) + 1;
        google.script.run
          .withSuccessHandler(data => {
            if (!data || !Array.isArray(data.movies) || !Array.isArray(data.tv)) {
              reject(new Error('Invalid data structure from getCombinedPopular'));
              return;
            }

            const row = document.getElementById('tmdbExploreRow');
            row.innerHTML = ''; // Clear previous results

            const limitedMovies = shuffleArray(data.movies).slice(0, 7);
            const limitedTV = shuffleArray(data.tv).slice(0, 7);
            const allItems = shuffleArray([...limitedMovies, ...limitedTV]);

            allItems.forEach(item => {
              const card = createCard(item, true, wishlistRequestedTitles);

              // Add AVAILABLE banner if already in wishlistAvailable
              const itemTitle = (item.title || item.name || '').toLowerCase();
              if (wishlistAvailableTitles.some(w => w.title.toLowerCase() === itemTitle && w.status === "Available")) {
                const banner = document.createElement('div');
                banner.textContent = 'AVAILABLE';
                banner.style.cssText = `
                  position: absolute;
                  top: 10px;
                  left: 0;
                  width: 100%;
                  background-color: rgba(0, 128, 0, 0.75);
                  color: white;
                  font-weight: bold;
                  text-align: center;
                  padding: 6px 0;
                  border-radius: 12px 12px 0 0;
                  font-size: 24px;
                  z-index: 20;
                  pointer-events: none;
                `;
                card.style.position = 'relative';
                card.appendChild(banner);
              }

              row.appendChild(card);
            });

            // Keep preview hidden/blank until the user selects an item
            const trailerContainer = document.getElementById('tmdbTrailerContainer');
            const preview = document.getElementById('tmdbDetailsPreview');
            if (trailerContainer) trailerContainer.innerHTML = '';
            if (preview) preview.style.display = 'none';

            resolve();
          })
          .withFailureHandler(error => reject(error))
          .getCombinedPopular(randomPage);
      });
    });
}
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}
let previewRotationInterval = null;
function startAutoPreviewRotation() {
  // Clear any existing interval to avoid duplicates
  if (previewRotationInterval) {
    clearInterval(previewRotationInterval);
  }

  previewRotationInterval = setInterval(() => {
    loadRandomTMDbPreview();
  }, 30000); // every 30 seconds
}

// WISHLIST
function addToWishlist(title, poster, btn) {
  // Immediately update UI
  if (btn) {
    btn.textContent = "✔";
    btn.style.backgroundColor = "green";
    btn.disabled = true;
  }

  google.script.run.withSuccessHandler(response => {
    if (!response) return;
    showPopup(`<b>${response.title}</b><br><span style="color:green;">Added to your wishlist!</span>`);
  }).withFailureHandler(err => {
    showPopup(`❌ Failed to add <b>${title}</b>. Error: ${err.message}`);
    // On failure, revert button UI back
    if (btn) {
      btn.textContent = "+";
      btn.style.backgroundColor = "#e50914";
      btn.disabled = false;
    }
  }).addToWishlistSheet(title, poster);
}
function renderWishlist(items) {
  const grid = document.getElementById('wishlistGrid');
  grid.innerHTML = '';

  // Normalize shapes/keys coming from server: {title, poster} OR {Title, Poster} etc.
  const normalized = (Array.isArray(items) ? items : []).map(it => {
    const title = (it && (it.title || it.Title || it.name || it.Name)) || 'Untitled';
    const poster = (it && (it.poster || it.Poster || it.image || it.Image)) || '';
    return { title: String(title).trim(), poster: String(poster).trim() };
  }).filter(it => it.title); // keep only valid titles

  console.log('Wishlist items (normalized):', normalized);

  if (normalized.length === 0) {
    grid.innerHTML = '<p style="color:#aaa; font-size:24px; text-align:center;">No requested items found.</p>';
    return;
  }

  shuffleArray(normalized).forEach(item => {
    const card = document.createElement('div');
    card.classList.add('movie-card');
    card.innerHTML = `
      <img src="${item.poster}" alt="${item.title}" loading="lazy" onerror="this.style.display='none'">
      <div class="movie-title">${item.title}</div>
    `;
    grid.appendChild(card);
  });

  // Make sure the section is visible (harmless if already visible)
  const section = document.getElementById('wishlistSection');
  if (section) section.style.display = 'block';
}
function loadWishlist() {
  return new Promise(resolve => {
    // Ping (optional but useful to confirm we’re on the right deployment)
    google.script.run
      .withSuccessHandler(v => console.log('PING (server version):', v))
      .withFailureHandler(err => console.warn('PING failed:', err))
      .pingWishlistVersion();

    // Fetch wishlist from the server
    google.script.run
      .withSuccessHandler(items => {
        console.log('Wishlist items (raw):', items);
        renderWishlist(items || []);
        resolve();
      })
      .withFailureHandler(err => {
        console.error('getRequestedWishlist failed:', err);
        renderWishlist([]);
        resolve();
      })
      .getRequestedWishlist();
  });
}

// RECENTLY ADDED
function renderRecentlyAdded(items) {
  const grid = document.getElementById('recentlyAddedGrid');
  grid.innerHTML = '';
  if (items.length === 0) {
    grid.innerHTML = '<p style="color:#aaa; font-size:24px; text-align:center;">No recent videos found.</p>';
    return;
  }
  shuffleArray(items).forEach(item => {
    const card = document.createElement('div');
    card.classList.add('movie-card');
    card.innerHTML = `
      <img src="${item.poster}" alt="${item.title}" loading="lazy">
      <div class="movie-title">${item.title}</div>
    `;
    card.addEventListener('click', () => {
      if (item.episodes && item.episodes.length > 1) {
        showEpisodes(item);
      } else if (item.episodes && item.episodes.length === 1) {
        openVideo(item.episodes[0].url, item.title);
      } else if (item.url) {
        openVideo(item.url, item.title);
      } else {
        alert("Video playback not available for this item.");
      }
    });
    grid.appendChild(card);
  });
}
function loadRecentlyAdded() {
  const grid = document.getElementById('recentlyAddedGrid');
  grid.innerHTML = `
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
  `;

  loadingScreen.style.display = "flex"; // Show loading screen

  return new Promise(resolve => {
    google.script.run.withSuccessHandler(items => {
      renderRecentlyAdded(items);
      hideLoadingScreen(); // Hide loading screen
      resolve();
    }).withFailureHandler(err => {
      console.error("❌ Failed to load recently added:", err);
      showPopup("Error loading recently added.");
      hideLoadingScreen(); // Hide loading screen
      resolve();
    }).getRecentVideos();
  });
}

// CONTINUE WATCHING
function loadContinueWatching() {
  return new Promise(resolve => {
    if (!currentProfile) {
      console.log("⚠️ No currentProfile, skipping continue watching");
      return resolve();
    }

    google.script.run.withSuccessHandler(data => {
      renderContinueWatching(data || []);
      resolve();
    }).getContinueWatching(currentProfile);
  });
}
function renderContinueWatching(items) {
  const container = document.getElementById("continueWatchingGrid");
  if (!container) return;
  container.innerHTML = "";

  if (!items || !Array.isArray(items) || items.length === 0) {
    container.innerHTML = "<p>No titles to continue watching yet.</p>";
    return;
  }

  const library = window.library;
  if (!library) return;

  items.forEach(item => {
    const normalize = str => str.replace(/\u00A0/g, ' ').trim().toLowerCase();
    const driveItem = [...library.movies, ...library.tv].find(lib =>
      normalize(lib.title) === normalize(item.title)
    );
    if (!driveItem) return;

    const episodeTitle = item.episode || "";
    const episode = driveItem.episodes?.find(ep =>
      normalize(ep.title) === normalize(episodeTitle)
    );
    const videoUrl = episode?.url || driveItem.episodes?.[0]?.url || driveItem.url;
    if (!videoUrl) return;

    const card = document.createElement("div");
    card.className = "movie-card";
    card.innerHTML = `
      <img src="${driveItem.poster}" alt="${driveItem.title}" loading="lazy">
      <div class="movie-title">${driveItem.title}</div>
    `;
    card.addEventListener("click", () => {
      openVideo(videoUrl, driveItem.title, item.episode, item.time);
    });
    container.appendChild(card);
  });

  document.getElementById("continueWatchingSection").style.display = "block";
}

// DETAILS & TRAILERS
async function fetchTMDbDetails(item, isTV = false) {
  const apiKey = '48f719a14913f9d4ee92c684c2187625';
  const baseUrl = 'https://api.themoviedb.org/3';
  const type = isTV ? 'tv' : 'movie';
  const url = `${baseUrl}/${type}/${item.id}?api_key=${apiKey}&language=en-US&append_to_response=videos,keywords`;

  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    return await response.json();
  } catch (error) {
    console.warn(`⚠️ TMDb fetch failed for "${item.title || item.name || 'Unknown'}": ${error.message}`);

    const trailerContainer = document.getElementById('tmdbTrailerContainer');
    const titleElem = document.getElementById('tmdbDetailsTitle');
    const dateElem = document.getElementById('tmdbDetailsReleaseDate');
    const overviewElem = document.getElementById('tmdbDetailsOverview');
    const preview = document.getElementById('tmdbDetailsPreview');

    if (trailerContainer) trailerContainer.innerHTML = '<p><em>Details not available for this title.</em></p>';
    if (titleElem) titleElem.textContent = item.title || item.name || 'Unknown';
    if (dateElem) dateElem.innerHTML = '';
    if (overviewElem) overviewElem.textContent = 'We could not load details from TMDb.';
    if (preview) preview.style.display = 'block';

    return null;
  }
}

function loadRandomTMDbPreview() {
  const cards = document.querySelectorAll('#tmdbExploreRow .movie-card');
  if (!cards.length) return;

  const randomIndex = Math.floor(Math.random() * cards.length);
  const randomCard = cards[randomIndex];

  const title = randomCard.querySelector('.movie-title')?.textContent || '';
  const poster = randomCard.querySelector('img')?.src || '';
  const isTV = title.includes('(TV)'); // Only if you're marking it visibly

  // You can also store media_type in dataset:
  // const mediaType = randomCard.dataset.mediaType;

  // Reuse the data from your render method
  const matched = [...fullLibrary].find(item =>
    (item.title || item.name)?.toLowerCase() === title.toLowerCase()
  );

  if (!matched) return;

  fetchTMDbDetails(matched, matched.media_type === 'tv')
    .then(data => {
      if (!data) return;

      const trailer = data.videos?.results.find(
        v => v.type === 'Trailer' && v.site === 'YouTube'
      );

      const trailerContainer = document.getElementById('tmdbTrailerContainer');
      trailerContainer.innerHTML = trailer
        ? `<iframe id="tmdbTrailerFrame" src="https://www.youtube.com/embed/${trailer.key}" sandbox="allow-same-origin allow-scripts allow-presentation allow-popups allow-forms" allowfullscreen style="width:100%;height:100%;border:none;border-radius:12px;"></iframe>`
        : `<p><em>No trailer available.</em></p>`;

      document.getElementById('tmdbDetailsTitle').textContent = data.name || data.title;
      document.getElementById('tmdbDetailsReleaseDate').innerHTML = `<strong>Release Date:</strong> ${data.first_air_date || data.release_date || 'N/A'}`;
      document.getElementById('tmdbDetailsOverview').textContent = data.overview || 'No overview available.';
      document.getElementById('tmdbDetailsPreview').style.display = 'block';
    });
}

function isContinueWatchingLoaded() {
  const container = document.getElementById("continueWatchingGrid");
  return container && container.children.length > 0;
}

let wishlistRequestedTitles = [];
function loadWishlistRequested() {
  return new Promise(resolve => {
    google.script.run.withSuccessHandler(items => {
      wishlistRequestedTitles = items.filter(item => item.status === "Wishlist");
      wishlistAvailableTitles = items.filter(item => item.status === "Available");
      resolve();
    }).getWishlistAllWithStatus();
  });
}

let lastFocusedElement = null;

function openModal() {
  lastFocusedElement = document.activeElement;

  if (lastFocusedElement && typeof lastFocusedElement.blur === 'function') {
    lastFocusedElement.blur();
  }

  const modal = document.getElementById('videoModal');
  modal.classList.add('active');
  document.getElementById('closeBtn').focus();

  if (previewRotationInterval) {
    clearInterval(previewRotationInterval);
    previewRotationInterval = null;
  }
}

function closeModal() {
  const modal = document.getElementById('videoModal');
  const videoFrameContainer = document.getElementById('videoFrameContainer');

  if (!modal || !videoFrameContainer) return;

  if (document.activeElement && typeof document.activeElement.blur === 'function') {
    document.activeElement.blur();
  }

  saveProgress();

  modal.classList.remove('active');
  videoFrameContainer.innerHTML = '';

  startAutoPreviewRotation();

  if (lastFocusedElement && document.body.contains(lastFocusedElement)) {
    lastFocusedElement.focus();
  }
}

function checkStickyShadow() {
  const stickyOffset = 100;  // or your preferred threshold
  const titles = document.querySelectorAll('.section-title, .tmdb-title');
  titles.forEach(el => {
    const rect = el.getBoundingClientRect();
    if (rect.top <= stickyOffset) {
      el.classList.add('sticky-shadow');
    } else {
      el.classList.remove('sticky-shadow');
    }
  });
}

window.addEventListener('scroll', checkStickyShadow);
window.addEventListener('load', checkStickyShadow);

window.addEventListener("DOMContentLoaded", () => {
  document.documentElement.style.visibility = "visible";

  const profileModal = document.getElementById("profileModal");
  if (profileModal) {
    profileModal.classList.add("active");
    console.log("✅ Modal forced visible");
  } else {
    console.warn("⚠️ Modal not found");
  }
});

waitForImagesToLoad(document.getElementById('appContent')).then(() => {
  console.log("✅ All images loaded");
});

document.querySelectorAll('.nav-item[data-section]').forEach(btn => {
  btn.addEventListener('click', () => {
    const section = btn.getAttribute('data-section');
    if (section === 'moviesSection' || section === 'tvSection') {
      loadLibrary();
    } else if (section === 'wishlistSection') {
      loadWishlist();
    }
  });
});

document.getElementById('mobileExploreRefresh').addEventListener('click', () => {
  loadCombinedPopular().then(() => console.log('Explore refreshed'));
});

let libraryLoaded = false;
</script>
</body>
</html>
